# 上位机智能挖掘检测系统架构逻辑图

## 🏗️ 系统总体架构图

```mermaid
graph TB
    subgraph "用户界面层"
        GUI[Tkinter GUI<br/>双视图显示]
        CONTROL[控制面板<br/>参数调节]
        STATUS[状态显示<br/>实时监控]
    end
    
    subgraph "数据处理层"
        PARSER[协议解析器<br/>帧解析校验]
        PREPROC[数据预处理<br/>高通滤波]
        BUFFER[数据缓存<br/>循环队列]
    end
    
    subgraph "智能检测层"
        COARSE[粗检测器<br/>时域特征]
        FINE[细检测器<br/>频域分类]
        DECISION[决策融合<br/>置信度计算]
    end
    
    subgraph "通信控制层"
        SERIAL[串口管理<br/>线程安全]
        PROTOCOL[命令协议<br/>0x10报警触发]
        QUEUE[数据队列<br/>异步处理]
    end
    
    subgraph "日志记录层"
        LOGGER[检测日志<br/>文本记录]
        RECORDER[事件记录<br/>JSON存储]
        MONITOR[系统监控<br/>性能统计]
    end
    
    GUI --> PARSER
    PARSER --> PREPROC
    PREPROC --> BUFFER
    BUFFER --> COARSE
    COARSE --> FINE
    FINE --> DECISION
    DECISION --> SERIAL
    SERIAL --> PROTOCOL
    PROTOCOL --> LOGGER
    LOGGER --> RECORDER
    RECORDER --> MONITOR
```

## 📊 数据流架构图

```mermaid
flowchart LR
    subgraph "数据接收"
        A1[STM32串口数据<br/>115200bps]
        A2[多线程接收<br/>异步处理]
        A3[数据队列<br/>缓冲管理]
    end
    
    subgraph "协议解析"
        B1[帧头检测<br/>AA55搜索]
        B2[帧结构解析<br/>命令+长度+载荷]
        B3[校验和验证<br/>XOR校验]
        B4[数据类型识别<br/>01/02/04命令]
    end
    
    subgraph "数据预处理"
        C1[5Hz高通滤波<br/>Butterworth 4阶]
        C2[单位转换<br/>g/mg/μg]
        C3[数据归一化<br/>特征缩放]
        C4[异常值检测<br/>范围检查]
    end
    
    subgraph "智能分析"
        D1[粗检测<br/>RMS+峰值因子]
        D2[细检测<br/>频域特征分类]
        D3[置信度计算<br/>多特征融合]
        D4[结果判定<br/>挖掘/正常]
    end
    
    subgraph "结果输出"
        E1[GUI更新<br/>实时显示]
        E2[报警触发<br/>0x10命令]
        E3[日志记录<br/>事件存储]
        E4[统计分析<br/>性能监控]
    end
    
    A1 --> A2 --> A3
    A3 --> B1 --> B2 --> B3 --> B4
    B4 --> C1 --> C2 --> C3 --> C4
    C4 --> D1 --> D2 --> D3 --> D4
    D4 --> E1
    D4 --> E2
    D4 --> E3
    D4 --> E4
```

## 🧠 智能检测算法架构图

```mermaid
graph TD
    subgraph "两级检测架构"
        subgraph "粗检测器 (时域分析)"
            A1[原始加速度数据<br/>三轴 X,Y,Z]
            A2[高通滤波<br/>5Hz截止频率]
            A3[特征提取<br/>RMS, 峰值因子]
            A4[阈值判断<br/>基线RMS×倍数]
            A5[持续时间检查<br/>≥1秒触发]
            A6{粗检测结果}
        end
        
        subgraph "细检测器 (频域分析)"
            B1[257点FFT数据<br/>0-500Hz频谱]
            B2[频域特征提取<br/>5维特征向量]
            B3[规则分类器<br/>挖掘特征规则]
            B4[置信度计算<br/>多规则加权]
            B5[最终判定<br/>置信度阈值]
            B6{细检测结果}
        end
    end
    
    A1 --> A2 --> A3 --> A4 --> A5 --> A6
    A6 -->|触发| B1
    A6 -->|正常| END1[正常状态]
    B1 --> B2 --> B3 --> B4 --> B5 --> B6
    B6 -->|挖掘| ALARM[发送报警]
    B6 -->|正常| END2[正常状态]
    
    style A6 fill:#fff3e0
    style B6 fill:#ffcdd2
    style ALARM fill:#f44336,color:#fff
```

## 🎛️ GUI双视图架构图

```mermaid
graph TB
    subgraph "主窗口 (1400×1100)"
        subgraph "控制面板区域"
            C1[串口连接<br/>端口选择]
            C2[检测控制<br/>启用/禁用]
            C3[参数调节<br/>灵敏度设置]
            C4[显示控制<br/>单位/缩放]
        end
        
        subgraph "频域显示区域 (上半部分)"
            F1[频谱图表<br/>Matplotlib]
            F2[频率轴<br/>0-500Hz]
            F3[幅度轴<br/>g/mg/μg]
            F4[峰值标注<br/>主频显示]
            F5[网格显示<br/>可选开关]
        end
        
        subgraph "时域显示区域 (下半部分)"
            T1[原始数据图表<br/>三轴加速度]
            T2[时间轴<br/>最近10秒]
            T3[加速度轴<br/>自动缩放]
            T4[三轴曲线<br/>X/Y/Z轴]
            T5[实时更新<br/>10Hz频率]
        end
        
        subgraph "状态信息区域"
            S1[连接状态<br/>串口状态]
            S2[检测状态<br/>触发/正常]
            S3[性能指标<br/>更新率/延迟]
            S4[统计信息<br/>检测次数/准确率]
        end
    end
    
    C1 --> F1
    C2 --> T1
    C3 --> F4
    C4 --> T3
    
    F1 --> F2 --> F3 --> F4 --> F5
    T1 --> T2 --> T3 --> T4 --> T5
    S1 --> S2 --> S3 --> S4
    
    style F1 fill:#e3f2fd
    style T1 fill:#e8f5e8
    style S1 fill:#fff3e0
```

## 🔄 多线程架构图

```mermaid
graph LR
    subgraph "多线程架构"
        subgraph "主线程 (GUI Thread)"
            M1[界面更新<br/>Tkinter事件循环]
            M2[图表绘制<br/>Matplotlib渲染]
            M3[用户交互<br/>按钮/控件响应]
            M4[状态显示<br/>实时信息更新]
        end
        
        subgraph "数据接收线程 (Serial Thread)"
            S1[串口监听<br/>阻塞式读取]
            S2[数据缓冲<br/>字节流处理]
            S3[队列投递<br/>线程间通信]
            S4[异常处理<br/>连接断开恢复]
        end
        
        subgraph "数据处理线程 (Process Thread)"
            P1[队列消费<br/>数据取出]
            P2[协议解析<br/>帧结构分析]
            P3[智能检测<br/>算法处理]
            P4[结果通知<br/>GUI更新触发]
        end
        
        subgraph "线程同步机制"
            L1[数据队列<br/>Queue.Queue]
            L2[状态锁<br/>threading.Lock]
            L3[串口锁<br/>serial_lock]
            L4[事件通知<br/>threading.Event]
        end
    end
    
    S1 --> S2 --> S3 --> L1
    L1 --> P1 --> P2 --> P3 --> P4
    P4 --> M1 --> M2 --> M3 --> M4
    
    L2 -.-> M1
    L2 -.-> P3
    L3 -.-> S1
    L4 -.-> P4
    
    style M1 fill:#e3f2fd
    style S1 fill:#e8f5e8
    style P1 fill:#fff3e0
    style L1 fill:#f3e5f5
```

## 📡 通信协议处理架构图

```mermaid
graph TD
    subgraph "协议处理流水线"
        A[串口数据流<br/>字节流输入]
        B[缓冲区管理<br/>bytearray缓存]
        C[帧头搜索<br/>AA55模式匹配]
        D[帧长度解析<br/>小端序2字节]
        E[载荷提取<br/>数据段分离]
        F[校验和验证<br/>XOR算法]
        G{校验通过?}
        H[命令分发<br/>01/02/04路由]
        I[数据解析<br/>结构化处理]
        J[类型封装<br/>字典格式]
        K[队列投递<br/>后续处理]
        L[丢弃帧<br/>错误处理]
    end
    
    A --> B --> C --> D --> E --> F --> G
    G -->|是| H --> I --> J --> K
    G -->|否| L
    L --> B
    
    subgraph "数据类型处理"
        H1[0x01: 21点频谱<br/>88字节载荷]
        H2[0x02: 原始数据<br/>16字节载荷]
        H3[0x04: 257点频谱<br/>1032字节载荷]
    end
    
    H --> H1
    H --> H2
    H --> H3
    
    style G fill:#fff3e0
    style K fill:#c8e6c9
    style L fill:#ffcdd2
```

## 🎯 智能检测决策树

```mermaid
graph TD
    START[接收原始数据] --> FILTER[5Hz高通滤波]
    FILTER --> COARSE{粗检测}
    
    COARSE -->|RMS > 阈值<br/>峰值因子 > 2.0<br/>持续 > 1秒| TRIGGERED[粗检测触发]
    COARSE -->|否| NORMAL1[正常状态]
    
    TRIGGERED --> WAIT[等待FFT数据]
    WAIT --> FINE{细检测}
    
    FINE --> FEATURES[提取频域特征]
    FEATURES --> RULES[应用分类规则]
    
    RULES --> R1{低频能量比 > 0.4}
    RULES --> R2{中频能量比 > 0.2}
    RULES --> R3{主频 < 50Hz}
    RULES --> R4{频谱重心 < 80Hz}
    RULES --> R5{谐波强度 > 0.1}
    
    R1 --> CONF[计算置信度]
    R2 --> CONF
    R3 --> CONF
    R4 --> CONF
    R5 --> CONF
    
    CONF --> THRESHOLD{置信度 ≥ 0.8}
    THRESHOLD -->|是| MINING[挖掘检测]
    THRESHOLD -->|否| NORMAL2[正常状态]
    
    MINING --> ALARM[发送0x10命令]
    MINING --> LOG[记录事件]
    
    style COARSE fill:#fff3e0
    style FINE fill:#fff3e0
    style MINING fill:#ffcdd2
    style ALARM fill:#f44336,color:#fff
```

## 📊 数据缓存管理架构图

```mermaid
graph LR
    subgraph "数据缓存架构"
        subgraph "频域数据缓存"
            F1[频谱缓存<br/>deque(100)]
            F2[频率数组<br/>257点固定]
            F3[幅度数组<br/>动态更新]
            F4[时间戳<br/>更新追踪]
        end
        
        subgraph "时域数据缓存"
            T1[X轴缓存<br/>deque(1000)]
            T2[Y轴缓存<br/>deque(1000)]
            T3[Z轴缓存<br/>deque(1000)]
            T4[时间缓存<br/>deque(1000)]
        end
        
        subgraph "检测结果缓存"
            D1[粗检测结果<br/>deque(100)]
            D2[细检测结果<br/>deque(100)]
            D3[置信度历史<br/>统计分析]
            D4[事件记录<br/>JSON存储]
        end
        
        subgraph "缓存管理策略"
            M1[自动清理<br/>超出长度丢弃]
            M2[内存监控<br/>使用量统计]
            M3[性能优化<br/>批量操作]
            M4[线程安全<br/>锁保护]
        end
    end
    
    F1 --> F2 --> F3 --> F4
    T1 --> T2 --> T3 --> T4
    D1 --> D2 --> D3 --> D4
    M1 --> M2 --> M3 --> M4
    
    F1 -.-> M1
    T1 -.-> M1
    D1 -.-> M1
    
    style F1 fill:#e3f2fd
    style T1 fill:#e8f5e8
    style D1 fill:#fff3e0
    style M1 fill:#f3e5f5
```

## 🔍 日志记录架构图

```mermaid
graph TB
    subgraph "日志系统架构"
        subgraph "检测日志 (DetectionLogger)"
            L1[文本日志<br/>detection_history.log]
            L2[日志级别<br/>INFO/ERROR/DEBUG]
            L3[时间戳<br/>精确到秒]
            L4[结构化信息<br/>RMS/置信度/特征]
        end
        
        subgraph "事件记录 (MiningEventRecorder)"
            E1[JSON存储<br/>mining_events.json]
            E2[详细数据<br/>完整事件信息]
            E3[传感器数据<br/>原始加速度值]
            E4[频域特征<br/>FFT分析结果]
        end
        
        subgraph "系统监控 (SystemMonitor)"
            S1[性能统计<br/>处理延迟/更新率]
            S2[准确率统计<br/>检测次数/误报率]
            S3[运行时间<br/>会话持续时间]
            S4[资源使用<br/>内存/CPU占用]
        end
        
        subgraph "日志管理"
            M1[文件轮转<br/>大小限制]
            M2[压缩存储<br/>历史数据]
            M3[查询接口<br/>日志检索]
            M4[导出功能<br/>数据分析]
        end
    end
    
    L1 --> L2 --> L3 --> L4
    E1 --> E2 --> E3 --> E4
    S1 --> S2 --> S3 --> S4
    M1 --> M2 --> M3 --> M4
    
    L1 -.-> M1
    E1 -.-> M1
    S1 -.-> M1
    
    style L1 fill:#e3f2fd
    style E1 fill:#e8f5e8
    style S1 fill:#fff3e0
    style M1 fill:#f3e5f5
```

## ⚡ 性能优化架构图

```mermaid
graph LR
    subgraph "性能优化策略"
        subgraph "数据处理优化"
            D1[NumPy向量化<br/>批量计算]
            D2[SciPy优化算法<br/>高效滤波]
            D3[内存预分配<br/>避免动态分配]
            D4[数据类型优化<br/>float32精度]
        end
        
        subgraph "GUI渲染优化"
            G1[增量更新<br/>只更新变化区域]
            G2[帧率控制<br/>限制更新频率]
            G3[双缓冲技术<br/>避免闪烁]
            G4[异步渲染<br/>非阻塞更新]
        end
        
        subgraph "内存管理优化"
            M1[循环缓冲区<br/>固定内存占用]
            M2[对象池技术<br/>减少GC压力]
            M3[惰性加载<br/>按需分配]
            M4[内存监控<br/>泄漏检测]
        end
        
        subgraph "算法优化"
            A1[特征缓存<br/>避免重复计算]
            A2[阈值预计算<br/>减少运算]
            A3[并行处理<br/>多核利用]
            A4[算法简化<br/>规则分类器]
        end
    end
    
    D1 --> D2 --> D3 --> D4
    G1 --> G2 --> G3 --> G4
    M1 --> M2 --> M3 --> M4
    A1 --> A2 --> A3 --> A4
    
    style D1 fill:#e3f2fd
    style G1 fill:#e8f5e8
    style M1 fill:#fff3e0
    style A1 fill:#f3e5f5
```

---

**Python智能挖掘检测上位机架构逻辑图 v3.3 - 完整的软件设计可视化** 🚀
