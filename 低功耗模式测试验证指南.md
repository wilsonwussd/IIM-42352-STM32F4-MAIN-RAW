# STM32智能震动检测系统低功耗模式测试验证指南

## 📋 **测试概述**

本文档提供了STM32智能震动检测系统低功耗模式的完整测试验证方案，确保Phase 1开发的功能正确性。

## 🔧 **测试环境准备**

### **硬件要求**
- STM32F407VGT6开发板
- IIM-42352传感器模块
- LoRa通信模块
- USB转串口调试器
- 示波器或万用表（功耗测量）

### **软件要求**
- Keil MDK-ARM
- 串口调试助手
- 本项目代码（包含低功耗模式）

### **编译配置**
确保以下宏定义已启用：
```c
#define ENABLE_LOW_POWER_MODE           1
#define RTC_WAKEUP_PERIOD_SEC           2
#define LOW_POWER_DEBUG_ENABLED         1
```

## 🚀 **Phase 1 功能测试**

### **测试1: 系统初始化验证**

**目标**: 验证低功耗管理和RTC初始化正常

**步骤**:
1. 编译并下载程序到STM32
2. 打开串口调试助手（115200, 8N1）
3. 复位系统，观察启动信息

**预期输出**:
```
LOW_POWER: Initializing low power manager...
RTC_WAKEUP: Initializing RTC...
RTC_WAKEUP: RTC initialized successfully
LOW_POWER: Low power manager initialized successfully
=== LOW POWER MODE ENABLED ===
LOW_POWER: Wakeup period: 2 seconds
LOW_POWER: Starting low power main loop
```

**验证标准**: ✅ 所有初始化信息正常显示，无ERROR信息

---

### **测试2: RTC唤醒周期验证**

**目标**: 验证2秒RTC唤醒周期准确性

**步骤**:
1. 系统启动后，观察串口输出
2. 记录连续10次唤醒的时间戳
3. 计算唤醒间隔

**预期输出**:
```
LOW_POWER: RTC wakeup handled (count: 1)
LOW_POWER: Starting detection process (count: 1)
LOW_POWER: Detection completed (duration: xxx ms)
LOW_POWER: Entering sleep mode...
LOW_POWER: Woke up from sleep mode (duration: 2000 ms)
LOW_POWER: RTC wakeup handled (count: 2)
...
```

**验证标准**: ✅ 唤醒间隔为2000ms ± 50ms

---

### **测试3: Sleep/Wake循环验证**

**目标**: 验证Sleep进入和唤醒流程正常

**步骤**:
1. 观察系统进入Sleep和唤醒的完整流程
2. 检查Sleep期间串口是否仍可输出调试信息
3. 验证唤醒后系统状态恢复正常

**预期行为**:
- 系统能正常进入Sleep模式
- RTC定时器正常唤醒系统
- 唤醒后所有外设功能正常
- 调试串口在整个过程中保持可用

**验证标准**: ✅ Sleep/Wake循环稳定，无死机或异常

---

### **测试4: 检测流程集成验证**

**目标**: 验证现有v4.0检测算法在低功耗模式下正常工作

**步骤**:
1. 在传感器上施加震动（轻微震动）
2. 观察粗检测是否正常工作
3. 施加较强震动，观察FFT是否被触发
4. 检查检测完成判断是否正确

**预期输出**:
```
LOW_POWER: Starting detection process (count: x)
[现有v4.0检测流程的输出]
- 传感器数据采集
- 5Hz高通滤波
- RMS滑动窗口计算
- 粗检测触发判断
- FFT智能触发（如果需要）
- 细检测算法（如果触发）
LOW_POWER: Detection completed (duration: xxx ms)
```

**验证标准**: ✅ 检测算法输出与连续模式一致

---

### **测试5: 调试命令验证**

**目标**: 验证新增的调试命令功能

**步骤**:
1. 发送命令 `0x20` - 查看低功耗统计
2. 发送命令 `0x21` - 切换到连续模式
3. 发送命令 `0x22` - 切换到低功耗模式

**预期响应**:
```
命令0x20:
=== LOW POWER STATISTICS ===
Sleep count: xx
Wakeup count: xx
Detection count: xx
...

命令0x21: "MODE_SET_CONTINUOUS"
命令0x22: "MODE_SET_LOW_POWER"
```

**验证标准**: ✅ 所有调试命令正常响应

---

## 📊 **性能验证测试**

### **测试6: 功耗测量**

**目标**: 验证功耗优化效果

**测试方法**:
1. 使用万用表测量系统平均电流
2. 分别测量Sleep期间和Active期间的电流
3. 计算平均功耗

**预期结果**:
- Sleep模式电流: < 0.2mA
- Active模式电流: 2-10mA（取决于检测活动）
- 平均功耗: < 1mA（假设每小时1次检测）

**验证标准**: ✅ 功耗比连续模式降低60%以上

---

### **测试7: 检测精度对比**

**目标**: 验证低功耗模式不影响检测精度

**测试方法**:
1. 准备标准震动测试信号
2. 分别在连续模式和低功耗模式下测试
3. 对比检测结果的一致性

**验证标准**: ✅ 检测精度差异 < 5%

---

## 🔍 **故障排查指南**

### **常见问题及解决方案**

#### **问题1: 系统无法进入Sleep模式**
**症状**: 串口显示"LOW_POWER: ERROR - Failed to start RTC wakeup"
**解决**: 检查RTC时钟配置，确保LSE晶振正常工作

#### **问题2: RTC唤醒不准确**
**症状**: 唤醒间隔不是2秒
**解决**: 检查RTC时钟源配置和分频设置

#### **问题3: 检测流程异常**
**症状**: 检测完成判断错误
**解决**: 检查状态机状态和中断标志清除

#### **问题4: 功耗过高**
**症状**: Sleep模式电流 > 1mA
**解决**: 检查外设关闭配置，确保不必要的外设已禁用

---

## ✅ **验收标准总结**

### **功能验收**
- [ ] 系统初始化正常，无错误信息
- [ ] RTC 2秒唤醒周期准确（±50ms）
- [ ] Sleep/Wake循环稳定运行
- [ ] 现有检测算法正常工作
- [ ] 调试命令响应正确

### **性能验收**
- [ ] 平均功耗 < 1mA
- [ ] 检测精度与连续模式一致
- [ ] 系统稳定运行 > 1小时无异常

### **兼容性验收**
- [ ] 可通过宏定义切换连续/低功耗模式
- [ ] 现有v4.0功能100%保持
- [ ] 调试接口完全兼容

---

## 📝 **测试记录模板**

```
测试日期: ___________
测试人员: ___________
硬件版本: ___________
软件版本: ___________

测试结果:
□ 测试1: 系统初始化验证 - 通过/失败
□ 测试2: RTC唤醒周期验证 - 通过/失败  
□ 测试3: Sleep/Wake循环验证 - 通过/失败
□ 测试4: 检测流程集成验证 - 通过/失败
□ 测试5: 调试命令验证 - 通过/失败
□ 测试6: 功耗测量 - 通过/失败
□ 测试7: 检测精度对比 - 通过/失败

问题记录:
_________________________________
_________________________________

总体评价: 通过/需要修改/失败
```

---

## 🎯 **下一步计划**

Phase 1验证通过后，可以进行：
1. **Phase 2**: 状态机扩展和优化
2. **Phase 3**: 高级功耗管理
3. **Phase 4**: 状态机扩展和测试  
4. **Phase 5**: 功耗测试和优化

每个Phase都需要按照类似的测试验证流程进行。
