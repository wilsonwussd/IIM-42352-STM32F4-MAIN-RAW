# 振动分析系统升级说明

## 新增功能：实时原始加速度数据显示

### 功能概述
在原有的频域分析功能基础上，新增了实时原始加速度数据显示功能，用户可以同时观察：
1. **频域分析图表** - 振动的频率成分分析
2. **原始数据图表** - 三轴加速度的实时波形

### 主要改进

#### STM32端改进
1. **新增原始数据协议** (命令码 0x02)
   - 发送频率：10Hz (每100个采样点发送一次)
   - 数据内容：时间戳 + X/Y/Z三轴加速度值
   - 数据格式：16字节载荷 (4字节时间戳 + 3×4字节float32)

2. **修改的文件**
   - `Core/Src/example-raw-data.c` - 添加原始数据发送功能
   - `Core/Inc/example-raw-data.h` - 添加函数声明

#### 上位机端改进
1. **界面布局优化**
   - 使用Notebook分页显示，支持频域和时域两个视图
   - 窗口尺寸调整为 1400×900 以容纳更多内容

2. **新增原始数据显示功能**
   - 实时显示最近10秒的三轴加速度数据
   - 自动调整Y轴范围以适应数据幅度
   - 不同颜色区分X/Y/Z三轴：红/绿/蓝

3. **协议解析扩展**
   - 支持命令码 0x02 的原始数据解析
   - 保持对原有频域数据的完全兼容

### 使用方法

#### 1. 编译和烧录STM32代码
```bash
# 使用Keil MDK或STM32CubeIDE编译项目
# 烧录到STM32F407开发板
```

#### 2. 运行上位机
```bash
# 安装依赖（如果还未安装）
pip install PyQt5 pyqtgraph pyserial numpy matplotlib

# 运行中文版上位机
python vibration_analyzer_chinese.py
```

#### 3. 操作步骤
1. 选择正确的串口（通常是COM6或类似）
2. 点击"连接"按钮
3. 在"频域分析"页面观察振动频谱
4. 切换到"原始加速度数据"页面观察实时波形
5. 使用"显示原始数据"复选框控制是否显示原始数据

### 数据传输协议

#### 原始加速度数据帧格式
```
帧头(2) + 命令(1) + 长度(2) + 载荷(16) + 校验(1) + 帧尾(1) = 23字节

帧头: 0xAA 0x55
命令: 0x02 (原始加速度数据)
长度: 0x10 0x00 (16字节，小端序)
载荷: 时间戳(4) + X轴(4) + Y轴(4) + Z轴(4)
校验: XOR校验
帧尾: 0x0D
```

#### 数据发送频率
- **频域数据**: ~2Hz (257点高分辨率)
- **原始数据**: 10Hz (三轴加速度)
- **总带宽**: ~2.5KB/s

### 测试工具

#### test_raw_data.py
提供了一个简单的测试脚本来验证原始数据接收功能：
```bash
python test_raw_data.py
```

该脚本会：
- 列出可用串口
- 连接到STM32设备
- 实时显示接收到的原始加速度数据
- 统计数据包接收情况

### 技术细节

#### 内存使用优化
- 原始数据缓存：最多保存1000个数据点
- 显示窗口：最近10秒数据
- 自动清理过期数据，避免内存泄漏

#### 性能考虑
- 原始数据发送频率限制在10Hz，避免串口拥塞
- 频域数据优先级更高，保证分析功能不受影响
- 使用高效的循环缓冲区管理数据

### 故障排除

#### 常见问题
1. **只看到频域数据，没有原始数据**
   - 检查"显示原始数据"复选框是否勾选
   - 确认STM32代码已更新并重新烧录

2. **原始数据显示异常**
   - 检查串口连接是否稳定
   - 重启上位机程序

3. **数据更新缓慢**
   - 正常情况下原始数据10Hz更新
   - 如果更新过慢，检查串口波特率设置

#### 调试方法
```bash
# 使用测试脚本验证数据接收
python test_raw_data.py

# 检查串口数据流
# 应该看到命令码0x02的原始数据包和0x04的频域数据包
```

### 兼容性说明
- 完全向后兼容原有功能
- 原有的21点和257点频域数据格式保持不变
- 可以选择性启用/禁用原始数据显示

### 未来扩展
- 支持原始数据录制和回放
- 添加时域分析功能（RMS、峰值检测等）
- 支持多传感器同时显示
